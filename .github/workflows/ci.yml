name: CI/CD

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch: # For manual production deployment

jobs:
  # =====================
  # STAGE 1: TESTS
  # =====================
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: 1.23

      - name: Get dependencies
        run: |
          go mod download

      - name: Run Vet
        run: go vet ./...

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v3
        with:
          version: latest

      - name: Run Unit Tests
        run: go test -v ./...

      - name: Run Race Detector
        run: go test -race -short ./...

  # =====================
  # STAGE 2: BUILD & PUSH
  # =====================
  build:
    name: Build Docker
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker Image
        run: |
          docker build . --file Dockerfile --tag massage-bot:latest
          # To push, uncomment and set secrets:
          # echo "$CR_PAT" | docker login ghcr.io -u $GITHUB_ACTOR --password-stdin
          # docker push ghcr.io/$GITHUB_REPOSITORY/massage-bot:latest

  # =====================
  # STAGE 3: DEPLOY
  # =====================
  # NOTE: Deploy stages disabled - GitLab CI/CD handles all deployments.
  # The mirror.yml workflow syncs code to GitLab, which then triggers deploys.
  # Keeping this commented for reference.
  #
  # deploy-test:
  #   name: Deploy to Test (Staging)
  #   needs: build
  #   runs-on: ubuntu-latest
  #   if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
  #   steps:
  #     - name: Deploy via SSH
  #       uses: appleboy/ssh-action@v1.0.0
  #       with:
  #         host: ${{ secrets.HOME_SERVER_IP }}
  #         username: kirill
  #         key: ${{ secrets.SSH_PRIVATE_KEY }}
  #         port: 2222
  #         script: |
  #           echo "ðŸ§ª Automatically deploying to Test Environment..."
  #           cd /opt/vera-bot-test && bash scripts/deploy_test_server.sh
  #
  # deploy-production:
  #   name: Deploy to Production
  #   needs: build
  #   runs-on: ubuntu-latest
  #   if: github.event_name == 'workflow_dispatch' # Manual trigger only
  #   steps:
  #     - name: Deploy via SSH
  #       uses: appleboy/ssh-action@v1.0.0
  #       with:
  #         host: ${{ secrets.HOME_SERVER_IP }}
  #         username: kirill
  #         key: ${{ secrets.SSH_PRIVATE_KEY }}
  #         port: 2222
  #         script: |
  #           echo "ðŸš€ Manually deploying to PRODUCTION..."
  #           cd /opt/vera-bot && bash scripts/deploy_home_server.sh

name: Mirror to GitLab

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Mirror to GitLab
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
          set -euo pipefail

          if [ -z "${GITLAB_TOKEN:-}" ]; then
            echo "ERROR: GITLAB_TOKEN is empty or not set"
            exit 1
          fi

          echo "=== Git Push via HTTPS ==="
          git remote add gitlab https://oauth2:${GITLAB_TOKEN}@gitlab.com/kfilin/massage-bot.git || \
            git remote set-url gitlab https://oauth2:${GITLAB_TOKEN}@gitlab.com/kfilin/massage-bot.git

          git push -v gitlab master || git push -v --force gitlab master
          echo "Mirror complete!"
